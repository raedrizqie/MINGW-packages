# Contributor: Raed Rizqie <raed.rizqie@gmail.com>

_realname=py2exe
pkgbase=mingw-w64-python-${_realname}
pkgname=${MINGW_PACKAGE_PREFIX}-python-${_realname}
pkgver=0.14.0.0
pkgrel=1
pkgdesc='A distutils extension to create standalone Windows programs from Python code (mingw-w64)'
arch=('any')
mingw_arch=('mingw64' 'ucrt64' 'clang64' 'clangarm64')
msys2_references=(
  'purl: pkg:pypi/py2exe'
)
msys2_repository_url='https://github.com/py2exe/py2exe'
url='http://www.py2exe.org/'
license=('spdx:MIT AND MPL-2.0')
depends=("${MINGW_PACKAGE_PREFIX}-python"
         "${MINGW_PACKAGE_PREFIX}-python-cachetools"
         "${MINGW_PACKAGE_PREFIX}-python-pefile")
makedepends=("${MINGW_PACKAGE_PREFIX}-python-build"
             "${MINGW_PACKAGE_PREFIX}-python-installer"
             "${MINGW_PACKAGE_PREFIX}-python-setuptools"
             "${MINGW_PACKAGE_PREFIX}-cc")
source=(https://github.com/py2exe/${_realname}/archive/v${pkgver}/${_realname}-${pkgver}.tar.gz)
sha256sums=('ea771e35d509d6d04e6fe949e0c4bcc2ccddab9876805639fcdd319aa13a4a45')

prepare() {
  cd "${_realname}-${pkgver}"
}

build() {
  # build separate zipextimporter wheel for _memimporter pyd (#20382)
  cp -r "${_realname}-${pkgver}" "python-build-${MSYSTEM}-zipextimporter"
  pushd "${srcdir}/python-build-${MSYSTEM}-zipextimporter"
  mv setup_zipextimporter.py setup.py
  python -m build --wheel --skip-dependency-check --no-isolation
  popd

  rm -rf python-build-${MSYSTEM} | true
  cp -r "${_realname}-${pkgver}" "python-build-${MSYSTEM}"
  cd "${srcdir}/python-build-${MSYSTEM}"
  python -m build --wheel --skip-dependency-check --no-isolation
}

package() {
  cd "python-build-${MSYSTEM}-zipextimporter"
  MSYS2_ARG_CONV_EXCL="--prefix=" \
  python -m installer --prefix=${MINGW_PREFIX} --destdir="${pkgdir}" dist/*.whl

  local _pythonpath=`python -c "import sysconfig; print(sysconfig.get_path('platlib'))"`
  local _site_packages="${pkgdir}$(cygpath ${_pythonpath})"
  rm -rf "${_site_packages}"/zipextimporter*

  cd "${srcdir}/python-build-${MSYSTEM}"
  MSYS2_ARG_CONV_EXCL="--prefix=" \
  python -m installer --prefix=${MINGW_PREFIX} --destdir="${pkgdir}" dist/*.whl

  install -Dm644 LICENSE.txt "${pkgdir}${MINGW_PREFIX}/share/licenses/python-${_realname}/LICENSE"
}
